{
	"AWSTemplateFormatVersion" : "2010-09-09",
	"Description" : "System Operations for AWS v2.1: Lab 6 - Scaling in AWS (Linux)",
	"Parameters" : {
		"VPCCIDR" : {
			"Description" : "CIDR Block for VPC",
			"Type" : "String",
			"Default" : "10.5.0.0/16",
			"AllowedValues" : ["10.5.0.0/16"]
		},
		"PublicSubnet1Param" : {
			"Description" : "Public Subnet 1",
			"Type" : "String",
			"Default" : "10.5.10.0/24",
			"AllowedValues" : ["10.5.10.0/24"]
		},
		"PrivateSubnet1Param" : {
			"Description" : "Private Subnet 1",
			"Type" : "String",
			"Default" : "10.5.50.0/24",
			"AllowedValues" : ["10.5.50.0/24"]
		},
		"KeyName" : {
			"Type" : "String",
			"Description" : "Keyname for the keypair that Qwiklab will use to launch EC2 instances",
			"Default" : "default-lab-key"
		}
	},
	"Mappings" : {
		"AmazonLinuxAMI" : {
			"us-east-1": {
			        "AMI": "ami-b66ed3de"
			      },
			"us-west-1": {
			        "AMI": "ami-4b6f650e"
			      },
			"us-west-2": {
			        "AMI": "ami-b5a7ea85"
			      },
			"eu-west-1": {
			        "AMI": "ami-6e7bd919"
			      },
			"sa-east-1": {
			        "AMI": "ami-8737829a"
			      },
			"ap-southeast-1": {
			        "AMI": "ami-ac5c7afe"
			      },
			"ap-southeast-2": {
			        "AMI": "ami-63f79559"
			      },
			"ap-northeast-1": {
			        "AMI": "ami-4985b048"
			}
		}
	},
	"Resources" : {
		"VPC" : {
			"Type" : "AWS::EC2::VPC",
			"Properties" : {
				"CidrBlock" : {
					"Ref" : "VPCCIDR"
				},
				"EnableDnsSupport" : "true",
				"EnableDnsHostnames" : "true",
				"Tags" : [{
						"Key" : "VPC",
						"Value" : "NAT-and-CLI"
					}, {
						"Key" : "Name",
						"Value" : "Lab VPC"
					}
				]
			}
		},
		"InternetGateway" : {
			"Type" : "AWS::EC2::InternetGateway",
			"DependsOn" : "VPC"
		},
		"AttachGateway" : {
			"Type" : "AWS::EC2::VPCGatewayAttachment",
			"DependsOn" : ["VPC", "InternetGateway"],
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"InternetGatewayId" : {
					"Ref" : "InternetGateway"
				}
			}
		},
		"PublicSubnet1" : {
			"Type" : "AWS::EC2::Subnet",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"CidrBlock" : {
					"Ref" : "PublicSubnet1Param"
				},
				"AvailabilityZone" : {
					"Fn::Select" : [
						"0", {
							"Fn::GetAZs" : ""
						}
					]
				},
				"Tags" : [{
						"Key" : "Name",
						"Value" : "Public Subnet 1"
					}
				]
			}
		},
		"PrivateSubnet1" : {
			"Type" : "AWS::EC2::Subnet",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"CidrBlock" : {
					"Ref" : "PrivateSubnet1Param"
				},
				"AvailabilityZone" : {
					"Fn::Select" : [
						"0", {
							"Fn::GetAZs" : ""
						}
					]
				},
				"Tags" : [{
						"Key" : "Name",
						"Value" : "Private Subnet 1"
					}
				]
			}
		},
		"PublicRouteTable" : {
			"Type" : "AWS::EC2::RouteTable",
			"DependsOn" : ["VPC", "AttachGateway"],
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"Tags" : [{
						"Key" : "Name",
						"Value" : "Public"
					}
				]
			}
		},
		"PublicRoute" : {
			"Type" : "AWS::EC2::Route",
			"DependsOn" : ["PublicRouteTable", "AttachGateway"],
			"Properties" : {
				"RouteTableId" : {
					"Ref" : "PublicRouteTable"
				},
				"DestinationCidrBlock" : "0.0.0.0/0",
				"GatewayId" : {
					"Ref" : "InternetGateway"
				}
			}
		},
		"PublicSubnet1RouteTableAssociation" : {
			"Type" : "AWS::EC2::SubnetRouteTableAssociation",
			"DependsOn" : ["PublicRouteTable", "PublicSubnet1", "AttachGateway"],
			"Properties" : {
				"SubnetId" : {
					"Ref" : "PublicSubnet1"
				},
				"RouteTableId" : {
					"Ref" : "PublicRouteTable"
				}
			}
		},
		"PrivateRouteTable" : {
			"Type" : "AWS::EC2::RouteTable",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"Tags" : [{
						"Key" : "Name",
						"Value" : "Private"
					}
				]
			}
		},
		"PrivateSubnet1RouteTableAssociation" : {
			"Type" : "AWS::EC2::SubnetRouteTableAssociation",
			"DependsOn" : ["PublicRouteTable", "PrivateSubnet1", "AttachGateway"],
			"Properties" : {
				"SubnetId" : {
					"Ref" : "PrivateSubnet1"
				},
				"RouteTableId" : {
					"Ref" : "PrivateRouteTable"
				}
			}
		},
		"PrivateNetworkAcl" : {
			"Type" : "AWS::EC2::NetworkAcl",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"VpcId" : {
					"Ref" : "VPC"
				},
				"Tags" : [{
						"Key" : "Network",
						"Value" : "Private"
					}
				]
			}
		},
		"NATInstance" : {
			"Type" : "AWS::EC2::Instance",
			"DependsOn" : ["AttachGateway", "PublicRoute", "PublicSubnet1"],
			"Properties" : {
				"ImageId" : {
					"Fn::FindInMap" : [
						"AmazonLinuxAMI", {
							"Ref" : "AWS::Region"
						},
						"AMI"
					]
				},
				"KeyName" : {
					"Ref" : "KeyName"
				},
				"InstanceType" : "t2.small",
				"NetworkInterfaces" : [{
						"DeviceIndex" : "0",
						"AssociatePublicIpAddress" : "true",
						"SubnetId" : {
							"Ref" : "PublicSubnet1"
						},
						"GroupSet" : [{
								"Ref" : "NATSecurityGroup"
							}
						]
					}
				],
				"SourceDestCheck" : "false",
				"Tags" : [{
						"Key" : "Name",
						"Value" : "NAT"
					}
				],
				"UserData" : {
					"Fn::Base64" : {
						"Fn::Join" : [
							"\n",
							[
								"#!/bin/bash",
								"yum -y update",
								"echo 1 > /proc/sys/net/ipv4/ip_forward",
								"echo 0 > /proc/sys/net/ipv4/conf/eth0/send_redirects",
								"/sbin/iptables -t nat -A POSTROUTING -o eth0 -s 0.0.0.0/0 -j MASQUERADE",
								"/sbin/iptables-save > /etc/sysconfig/iptables",
								"mkdir -p /etc/sysctl.d/",
								"cat <<EOF > /etc/sysctl.d/nat.conf",
								"net.ipv4.ip_forward = 1",
								"net.ipv4.conf.eth0.send_redirects = 0",
								"EOF \n"
							]
						]
					}
				}
			}
		},
		"NATSecurityGroup" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"GroupDescription" : "Enable internal access to the NAT device",
				"VpcId" : {
					"Ref" : "VPC"
				},
				"SecurityGroupIngress" : [{
						"IpProtocol" : "tcp",
						"FromPort" : "0",
						"ToPort" : "1024",
						"CidrIp" : {
							"Ref" : "PrivateSubnet1Param"
						}
					}, {
						"IpProtocol" : "udp",
						"FromPort" : "0",
						"ToPort" : "1024",
						"CidrIp" : {
							"Ref" : "PrivateSubnet1Param"
						}
					}
				],
				"SecurityGroupEgress" : [{
						"IpProtocol" : "tcp",
						"FromPort" : "0",
						"ToPort" : "65535",
						"CidrIp" : "0.0.0.0/0"
					}, {
						"IpProtocol" : "udp",
						"FromPort" : "0",
						"ToPort" : "65535",
						"CidrIp" : "0.0.0.0/0"
					}
				]
			}
		},
		"PrivateRoute" : {
			"Type" : "AWS::EC2::Route",
			"DependsOn" : ["NATInstance", "PrivateRouteTable"],
			"Properties" : {
				"RouteTableId" : {
					"Ref" : "PrivateRouteTable"
				},
				"DestinationCidrBlock" : "0.0.0.0/0",
				"InstanceId" : {
					"Ref" : "NATInstance"
				}
			}
		},
		"CommandHostSecurityGroup" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"DependsOn" : "AttachGateway",
			"Properties" : {
				"GroupDescription" : "Security Group for Command Host",
				"VpcId" : {
					"Ref" : "VPC"
				},
				"Tags" : [{
						"Key" : "Name",
						"Value" : "CommandHostSecurityGroup"
					}
				],
				"SecurityGroupEgress" : [{
						"IpProtocol" : "tcp",
						"FromPort" : "0",
						"ToPort" : "65535",
						"CidrIp" : "0.0.0.0/0"
					}, {
						"IpProtocol" : "udp",
						"FromPort" : "0",
						"ToPort" : "65535",
						"CidrIp" : "0.0.0.0/0"
					}
				],
				"SecurityGroupIngress" : [{
						"IpProtocol" : "tcp",
						"FromPort" : "22",
						"ToPort" : "22",
						"CidrIp" : "0.0.0.0/0"
					},
					{
						"IpProtocol" : "tcp",
						"FromPort" : "80",
						"ToPort" : "80",
						"CidrIp" : "0.0.0.0/0"
					},
					{
						"IpProtocol" : "tcp",
						"FromPort" : "443",
						"ToPort" : "443",
						"CidrIp" : "0.0.0.0/0"
					}
				]
			}
		},
		"RootRole" : {
			"Type" : "AWS::IAM::Role",
			"Properties" : {
				"AssumeRolePolicyDocument" : {
					"Version" : "2012-10-17",
					"Statement" : [{
							"Effect" : "Allow",
							"Principal" : {
								"Service" : ["ec2.amazonaws.com"]
							},
							"Action" : ["sts:AssumeRole"]
						}
					]
				},
				"Path" : "/",
				"Policies" : [{
						"PolicyName" : "root",
						"PolicyDocument" : {
							"Version" : "2012-10-17",
							"Statement" : [{
									"Effect" : "Allow",
									"Action" : "*",
									"Resource" : "*"
								}
							]
						}
					}
				]
			}
		},
		"RootInstanceProfile" : {
			"Type" : "AWS::IAM::InstanceProfile",
			"DependsOn" : "RootRole",
			"Properties" : {
				"Path" : "/",
				"Roles" : [{
						"Ref" : "RootRole"
					}
				]
			}
		},
		"WaitHandle01" : {
			"Type" : "AWS::CloudFormation::WaitConditionHandle",
			"Properties" : {}
		},
		"WaitCondition01" : {
			"Type" : "AWS::CloudFormation::WaitCondition",
			"DependsOn" : "CommandHost",
			"Properties" : {
				"Handle" : {
					"Ref" : "WaitHandle01"
				},
				"Timeout" : "1800"
			}
		},
		"CommandHost" : {
			"Type" : "AWS::EC2::Instance",
			"DependsOn" : ["RootInstanceProfile", "PublicSubnet1", "CommandHostSecurityGroup", "AttachGateway"],
			"Properties" : {
				"KeyName" : {
					"Ref" : "KeyName"
				},
				"IamInstanceProfile" : {
					"Ref" : "RootInstanceProfile"
				},
				"ImageId" : {
					"Fn::FindInMap" : [
						"AmazonLinuxAMI", {
							"Ref" : "AWS::Region"
						},
						"AMI"
					]
				},
				"InstanceType" : "t2.medium",
				"NetworkInterfaces" : [{
						"DeviceIndex" : "0",
						"AssociatePublicIpAddress" : "true",
						"SubnetId" : {
							"Ref" : "PublicSubnet1"
						},
						"GroupSet" : [{
								"Ref" : "CommandHostSecurityGroup"
							}
						]
					}
				],
				"Tags" : [{
						"Key" : "Name",
						"Value" : "Command Host"
					}
				],
				"UserData" : {
					"Fn::Base64" : {
						"Fn::Join" : [
							"",
							[
								"#!/bin/bash -ex \n",
								"yum -y update \n",
								"mkdir /home/ec2-user/.aws \n",
								"cat > /home/ec2-user/.aws/config <<EOF\n",
								"[default]\n",
								"region = ", { "Ref" : "AWS::Region" }, "\n", 
								"EOF\n",
								"chown -R ec2-user:ec2-user /home/ec2-user/.aws\n",
								"cd /home/ec2-user\n", 
								"wget https://d2lrzjb0vjvpn5.cloudfront.net/sys-ops/v2.1/lab-6-scaling-linux/static/UserData.txt\n",
								"/opt/aws/bin/cfn-signal -s true '", {
									"Ref" : "WaitHandle01"
								}, "'\n"

							]
						]
					}
				}
			}
		}
	},
	"Outputs" : {
		"qwikLAB" : {
			"Description" : "Outputs to be used by qwikLAB",
			"Value" : {
				"Fn::Join" : [
					"",
					[
						"{",
						"\"Connection\": \"ssh ec2-user@", {
							"Fn::GetAtt" : [
								"CommandHost",
								"PublicIp"
							]
						},
						"\"}"
					]
				]
			}
		}
	}
}
